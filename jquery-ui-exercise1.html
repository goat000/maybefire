<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Planning Buckets</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
        /* I used px instead of vw/wh, because I'm not sure it makes sense to fit all of this onto
           one screen, no matter how small.  I'm living with scrollbars for now, instead.
           And in all honesty, this all may have bigger problems on small screens - I haven't
           tested it.*/

        /* Consistency across browsers.
           In Chrome, cleans up several little border offset issues nicely,
           and prevents slider handles from being shifted to the right a couple px. */
        * {
            font-family: Arial, Helvetica, sans-serif;
            box-sizing: border-box;            
        }

        body {
            /* Background color that ChatGPT suggested.  Works for me. */
            background-color: #f4f7f6;
        }

        /* I initially wanted a flexbox rather than grid at this highest level, because I didn't
           actually want the three major sections (i.e. the chunks separated by arrows) to be fully
           aligned. I'm not so sure it was the right call now, but I don't know that I'll go
           through the trouble of unifying this flexbox and its inner grids.
           
           I had been using flex-wrap:wrap, but as the layout evolved, it came to look pretty
           terribly muddled when wrapping. */
        #flexbox-container {
            display: flex;
            flex-wrap: nowrap;
        }
        #flexbox-container > div {
            margin-right: 10px;
        }

        /*         
           ****** Styles related to the slider section ******
           (which includes the tax bracket display to their left.)           
        */ 

        #sliders {
            display: grid;
            grid-template-rows: auto 1fr auto auto;
            grid-template-columns: 4;
            width: min-content;
        }

        #tax-bracket-indicator-container {
            display:grid;
            /*
               Bottom 29.2%: $29200 standard deduction (0% tax) for married filing jointly
               Middle 23.2%: Next $23200, 10% tax bracket
               Top 47.5%: Next $47500, 12% tax bracket.  The bracket goes further than that, but
                   max withdrawal in one year is 100k, in this exercise.

               All numbers are for 2024.
            */
            grid-template-rows: 47.6% 23.2% 29.2%;
            text-align: center;
            margin-right:5px;
        }

        .tax-bracket-indicator {
            /* vertically center text in dev */
            display: grid;
            align-items: center;
        }

        .slider-container {            
            margin-right: 10px;
            width: 100px;
        }

        .slider-label {
            height: 40px;
            width: 100px;
            text-align: center;
            margin-bottom: 5px;
        }

        .slider-vertical {
            width: 100px;
            height: 100%;
        }

        /* Image that is displayed on repeat on the filled portion of the sliders. */
        .slider-filled {
             /* Position and bottom attributes make it so that the background image is correctly
                anchored to the bottom of the slider, not the top. */
            position: absolute;
            bottom: 0;
            width: 100%;
            background: url('stack_of_money_recurring.png') repeat-y;
            background-position: bottom; /* So that the background image looks like it is being
                                            revealed, rather than like it is a curtain being pulled
                                            up. */
            z-index: 2;
        }

        .slider-vertical .ui-slider-handle {
            width: 100%;
            left: 0; /* Without this, the handles end up a bit to the left of the slider body. */
        }

        input.slider-value-input {
            color: #777; /* Not necessary, but kind of nice if the image were missing. */
            width: 67%;
            text-align: center;
            margin:auto;
            margin-top:20px;
        }

        /*         
           ****** Styles related to the tax buckets section ******
        */ 

        .buckets {
            width: 125px;
            text-align:center;
        }

        .bucket-label {
            margin-bottom:5px;
        }

        /* Three-sided "bucket" to be filled by withdrawal dollars in a given tax bracket. */
        /* The sides are borders.*/
        .bucket-container {
            width: 100px;
            height: 100px;
            margin: auto;
            border-bottom: 2px solid black;
            border-left: 2px solid black;
            border-right: 2px solid black;
            border-top: transparent;
            position: relative;
        }

        /* Might be more intuitive to reuse the image from the sliders, but I'm not sure, it seemed
           busy. */
        .bucket-fill {
            background-color: blue;
            width: 100%;
            height: 0%;
            position: absolute;
            bottom: 0;
        }

        input.bucket-value-numeric {
            /* Explicit width rather than 100%, because I don't want to shrink when
               the viewport is small. */
            width: 125px;
            height: 25 px;
            text-align: center;
            margin-top: 5px;
            border: none;
            background-color: transparent;
        }

        /*         
           ****** Styles related to the final results section ******
        */ 

        div.results {
            width: 250px;
            display: grid;
            grid-template-rows: 1fr auto auto 1fr;
        }

        input.total-tax {
            /* Explicit width rather than 100%, because I don't want to shrink when
               the viewport is small. */
            width: 250px;
            text-align: center;
            border: none;
            background-color: transparent;
        }

        #full-withdrawal-or-not {
            height: 45px;
            margin-top: 20px;
            font-weight: bold;
        }

        #min-tax-or-not {
            margin-top: 30px; font-weight:bold; text-align:center;
        }

        /*         
           ****** Styles in between the sections called out above ******
           (Really just the arrow emojis.)
        */ 

        div.arrow {
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            width: min-content;
            font-size: 50px;
        }
    </style>
</head>

<body>
    <div id="flexbox-container">
        <div id="sliders">
            <div id="tax-bracket-indicator-container" style="grid-row: 2; grid-column: 1;">
                <div class="tax-bracket-indicator" style="grid-row: 1; grid-column: 1; background-color:#B66">12%</div>
                <div class="tax-bracket-indicator" style="grid-row: 2; grid-column: 1; background-color:#FF6">10%</div>
                <div class="tax-bracket-indicator" style="grid-row: 3; grid-column: 1; background-color:#6B6">0%</div>
            </div>

            <div class="slider-label" style="grid-row: 1; grid-column: 2;">Year 1 Withdrawal</div>
            <div class="slider-container" style="grid-row: 2; grid-column: 2;">
                <div id="slider-vertical-0" class="slider-vertical">
                    <div id="slider-filled-0" class="slider-filled"></div>
                </div>
            </div>
            <input type="text" id="slider-value-0" class="slider-value-input" style="grid-row: 3; grid-column: 2;"/>

            <div class="slider-label" style="grid-row: 1; grid-column: 3">Year 2 Withdrawal</div>
            <div class="slider-container" style="grid-row: 2; grid-column: 3;">                
                <div id="slider-vertical-1" class="slider-vertical">
                    <div id="slider-filled-1" class="slider-filled"></div>
                </div>
            </div>
            <input type="text" id="slider-value-1" class="slider-value-input" style="grid-row: 3; grid-column: 3;"/>

            <div class="slider-label" style="grid-row: 1; grid-column: 4">Year 3 Withdrawal</div>
            <div class="slider-container" style="grid-row: 2; grid-column: 4;">
                <div id="slider-vertical-2" class="slider-vertical">
                    <div id="slider-filled-2" class="slider-filled"></div>
                </div>                
            </div>
            <input type="text" id="slider-value-2" class="slider-value-input" style="grid-row: 3; grid-column: 4;"/>
            <div id="full-withdrawal-or-not" style="grid-row: 4; grid-column-start: 1; grid-column-end: 5;"></div>
        </div>

        <div class="arrow"><p style="grid-row:2">➡️</p></div>

        <div class="buckets">
            <div class="bucket-label">Withdrawals taxed at 0%</div>
            <div class="bucket-container">
                <div class="bucket-fill" id="zero-percent-bucket"></div>
            </div>
            <input type="text" id="zero-percent-value" class="bucket-value-numeric" readonly/>
            <input type="text" id="zero-percent-tax" class="bucket-value-numeric" style="margin-bottom:25px;" readonly/>
            <div class="bucket-label">Withdrawals taxed at 10%</div>
            <div class="bucket-container">
                <div class="bucket-fill" id="ten-percent-bucket"></div>
            </div>
            <input type="text" id="ten-percent-value" class="bucket-value-numeric" readonly/>
            <input type="text" id="ten-percent-tax" class="bucket-value-numeric" style="margin-bottom:25px;" readonly/>
            <div class="bucket-label">Withdrawals taxed at 12%</div>
            <div class="bucket-container">
                <div class="bucket-fill"  id="twelve-percent-bucket"></div>
            </div>
            <input type="text" id="twelve-percent-value" class="bucket-value-numeric" readonly/>
            <input type="text" id="twelve-percent-tax" class="bucket-value-numeric" style="margin-bottom:25px;" readonly/>
        </div>

        <div class="arrow"><p style="grid-row:2">➡️</p></div>

        <div class="results">
            <div style="grid-row: 2; font-weight:bold">Total tax paid on all withdrawals</div>
            <input type="text" id="total-tax" class="total-tax" style="grid-row: 3; font-weight:bold; font-size: 20px;" readonly/>
            <div style="grid-row: 4;" id="min-tax-or-not"></div>
        </div>
    </div>

    <script>
        $(function() {
            const fullWithdrawalAmount = 100000;
            const minTax = 1240;

            const withdrawalStep = 100;
            
            const sizeOf0Bucket = 29200 * 3.0;
            const sizeOf10Bucket = 23200 * 3.0;
            const sizeOf12Bucket = 71100 * 3.0;

            const initialSliderValues = [50000, 30000, 20000];
            const initialBucketValues = [29200 + 29200 + 20000, 21600, 0];
            const initialTaxPerBucket = [0, 2160, 0];                             
            const initialTax = 2160; 

            const fullWithdrawalText = "You are withdrawing the full amount. ✔️";
            const partialWithdrawalText = "You are not withdrawing the full amount.<br>  Move the sliders until they add up to $100,000.";
            const optimalTax = "You are paying the lowest possible income tax on your $100,000 withdrawal.  <div style='font-size: 25px'>You Win!✔️</div>";
            const suboptimalTax = "You are paying <em>more</em> income tax than you have to.  Play with the sliders!";

            const usDollar = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            });

            function updateSliderHandles() {
                $(".slider-vertical").each(function() {
                    var value = $(this).slider("value");
                    $(this).find(".slider-filled").height((value / 100000) * $(this).height());
                });
            }

            // Return the overall tax amount as an int, so we don't have  to parse the
            // currency-formatted value in #total-tax.
            function updateBuckets() {
                var amountIn0Bucket = 0;
                var amountIn10Bucket = 0;
                var amountIn12Bucket = 0;
                var taxFrom0Bucket = 0;
                var taxFrom10Bucket = 0;
                var taxFrom12Bucket = 0;
                var overallTax = 0;

                $(".slider-vertical").each(function() {
                    var value = $(this).slider("value");
                    amountIn0Bucket += Math.min(value, 29200);
                    amountIn10Bucket += Math.max(0, Math.min(value - 29200, 23200));
                    amountIn12Bucket += Math.max(0, Math.min(value - 52400, 71100));
                });

                taxFrom10Bucket = 0.10 * amountIn10Bucket;
                taxFrom12Bucket = 0.12 * amountIn12Bucket;
                overallTax = taxFrom0Bucket + taxFrom10Bucket + taxFrom12Bucket;
                
                $('#zero-percent-bucket').height(100 * amountIn0Bucket / sizeOf0Bucket + '%');
                $('#ten-percent-bucket').height(100 * amountIn10Bucket / sizeOf10Bucket + '%');
                $('#twelve-percent-bucket').height(100 * amountIn12Bucket / sizeOf12Bucket + '%');

                $('#zero-percent-value').val("Withdrawal: " + usDollar.format(amountIn0Bucket));
                $('#ten-percent-value').val("Withdrawal: " + usDollar.format(amountIn10Bucket));
                $('#twelve-percent-value').val("Withdrawal: " + usDollar.format(amountIn12Bucket));

                $('#zero-percent-tax').val("Tax: " + usDollar.format(taxFrom0Bucket));
                $('#ten-percent-tax').val("Tax: " + usDollar.format(taxFrom10Bucket));
                $('#twelve-percent-tax').val("Tax: " + usDollar.format(taxFrom12Bucket));

                $('#total-tax').val(usDollar.format(overallTax));

                return overallTax;
            }

            function updateTextMessages(overallTax) {
                var totalWithdrawal = $('#slider-vertical-0').slider("value") + $('#slider-vertical-1').slider("value") + $('#slider-vertical-2').slider("value");
                if (totalWithdrawal == fullWithdrawalAmount) {
                    $('#full-withdrawal-or-not').html(fullWithdrawalText);

                    if (overallTax == minTax) {
                        $('#min-tax-or-not').html(optimalTax);
                    } else if (overallTax > minTax) {
                        $('#min-tax-or-not').html(suboptimalTax);
                    } else {
                        $('#min-tax-or-not').html("Error, sorry.");
                    }
                } else if (totalWithdrawal < fullWithdrawalAmount) {
                    $('#full-withdrawal-or-not').html(partialWithdrawalText);
                    $('#min-tax-or-not').html("");
                } else {
                    $('#full-withdrawal-or-not').text("Error, sorry.");
                    $('#min-tax-or-not').html("");
                } 
            }

            // Don't let the sliders past the total withdrawal amount
            function restrictSliders(index, proposedValue) {
                var allowedValue = proposedValue;
                var total = 0;

                // Calculate the total of the first three sliders
                $(".slider-vertical").each(function(i) {
                    if (i !== index) { // Exclude the current slider
                        total += $(this).slider("value");
                    }
                });

                var maxAllowedValue = 100000 - total; // Maximum value allowed for the current slider

                // If the proposed value is greater than the max allowed value, adjust it
                if (proposedValue > maxAllowedValue) {
                    allowedValue = maxAllowedValue;
                }

                return allowedValue; // Return the adjusted value for the slider
            }

            $(".slider-vertical").each(function(i) {
                var sliderId = 'slider-vertical-' + i;
                var sliderValueId = 'slider-value-' + i;                

                $('#' + sliderId).slider({
                    orientation: "vertical",
                    range: "min",
                    min: 0,
                    max: fullWithdrawalAmount,
                    value: initialSliderValues[i],
                    step: withdrawalStep,
                    slide: function(event, ui) {
                        var requestedValue = ui.value;
                        var adjustedValue = restrictSliders(i, requestedValue);

                        // If the adjusted value is different from the proposed value, prevent the
                        // slide.
                        if (adjustedValue !== requestedValue) {
                            event.preventDefault();
                        }

                        // I think the standard slider logic will update this value, but I'd like to do it
                        // before calling the update functions as a simple way to avoid them working on 
                        // numbers from before this event.  And it doesn't seem to hurt anything.
                        $(this).slider("value", adjustedValue);
                        $('#' + sliderValueId).val(usDollar.format(adjustedValue));
                        updateSliderHandles();
                        overallTax = updateBuckets();
                        updateTextMessages(overallTax);
                    },
                    create: function(event, ui) {
                        var initialValue = $(this).slider("value");
                        var initialHeight = (initialValue / 100000) * $(this).height();
                        $(this).children('.slider-filled').height(initialHeight);
                        $('#' + sliderValueId).val(usDollar.format(initialValue));
                    }
                });

                // Also allow changing the withdrawal values via text box
                $('#' + sliderValueId).on('change', function() {
                    // Hacky, but since we're hardcoded to one USD format, I don't feel _so_ bad.
                    // Intl.NumberFormat doesn't have a parse() method :-(
                    // And I don't really want to bring in another library.
                    // This does potentially parse invalid values, e.g. $54$0,,, => $540, but I
                    // can live with that.
                    var value = $(this).val().replaceAll(',','').replaceAll('$','');

                    var value = parseInt(value);
                    if (isNaN(value) || value < 0) {
                        value = 0
                        $(this).val(0);
                    } 


                    var adjustedValue = restrictSliders(i, value);

                    adjustedValue = Math.round(adjustedValue / withdrawalStep) * withdrawalStep;
                    
                    $(this).val(usDollar.format(adjustedValue));

                    $('#' + sliderId).slider("value", adjustedValue);
                    updateSliderHandles();
                    overallTax = updateBuckets();
                    updateTextMessages(overallTax);
                });

                // updateBuckets doesn't like to be called while initializing the slider,
                // so set hardcoded values initially.
                $('#zero-percent-bucket').height(100 * initialBucketValues[0] / sizeOf0Bucket + '%');
                $('#ten-percent-bucket').height(100 * initialBucketValues[1] / sizeOf10Bucket + '%');
                $('#twelve-percent-bucket').height(100 * initialBucketValues[2] / sizeOf12Bucket + '%');
                $('#zero-percent-value').val("Withdrawal: " + usDollar.format(initialBucketValues[0]));
                $('#ten-percent-value').val("Withdrawal: " + usDollar.format(initialBucketValues[1]));
                $('#twelve-percent-value').val("Withdrawal: " + usDollar.format(initialBucketValues[2]));
                $('#total-tax').val(usDollar.format(initialTax));
                $('#full-withdrawal-or-not').html(fullWithdrawalText);
                $('#min-tax-or-not').html(suboptimalTax);
                $('#zero-percent-tax').val("Tax: " + usDollar.format(initialTaxPerBucket[0]));
                $('#ten-percent-tax').val("Tax: " + usDollar.format(initialTaxPerBucket[1]));
                $('#twelve-percent-tax').val("Tax: " + usDollar.format(initialTaxPerBucket[2]));
            });
        });
    </script>
</body>
</html>

