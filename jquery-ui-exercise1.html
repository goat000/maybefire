<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Planning Buckets</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
        .slider-container {
            float: left;
            margin-right: 10px;
            width: 100px;
        }

        .slider-vertical {
            width: 100px;
            height: 200px;
            margin-top: 20px;
        }

        .slider-filled {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: url('stack_of_money_recurring.png') repeat-y;
            background-size: 100% auto;
            background-position: bottom;
            background-clip: content-box;
            z-index: 2;
        }

        .slider-vertical .ui-slider-handle {
            width: 100%;
            left: 0;
            margin-left: 0;
        }

        .slider-label {
            height: 50px; /* Adjust the height as needed to fit the largest label */
            text-align: center;
            margin-bottom: 5px; /* Add some space between the label and the slider */
            overflow: hidden; /* Prevents text from overflowing the fixed height */
        }

        .slider-value {
            text-align: center;
            margin-top: 5px;
        }

        input.slider-value-input {
            box-sizing:border-box;
            width: 100%;
            text-align: center;
            margin-top:20px;
        }

        .buckets {
            width: 175px;
            float:left;
            margin-left:25px;
            text-align:center;
        }

        .bucket-container {
            width: 100px;
            height: 100px;
            margin:auto;
            border-bottom: 2px solid black;
            border-left: 2px solid black;
            border-right: 2px solid black;
            border-top: transparent;
            position: relative;
        }

        .bucket-fill {
            background-color: blue;
            width: 100%;
            position: absolute;
            bottom: 0;
        }

        input.bucket-value-numeric {
            box-sizing:border-box;
            width: 100%;
            text-align: center;
            margin-top:5px;
            margin-bottom:20px;
            border-width:0px;
            border:none;
        }

        div.results {
            float:left;
            width:250px;
        }

        input.total-tax {
            box-sizing:border-box;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

    </style>
</head>
<body>
    <div id="sliders">
        <div class="slider-container">
            <div class="slider-label">Year 1 Withdrawal</div>
            <div id="slider-vertical-0" class="slider-vertical">
                <div id="slider-filled-0" class="slider-filled"></div>
            </div>
            <input type="text" id="slider-value-0" class="slider-value-input"/>
        </div>
        <div class="slider-container">
            <div class="slider-label">Year 2 Withdrawal</div>
            <div id="slider-vertical-1" class="slider-vertical">
                <div id="slider-filled-1" class="slider-filled"></div>
            </div>
            <input type="text" id="slider-value-1" class="slider-value-input"/>
        </div>
        <div class="slider-container">
            <div class="slider-label">Year 3 Withdrawal</div>
            <div id="slider-vertical-2" class="slider-vertical">
                <div id="slider-filled-2" class="slider-filled"></div>
            </div>
            <input type="text" id="slider-value-2" class="slider-value-input"/>
        </div>
        <div class="buckets">
            Withdrawals taxed at 0%
            <div class="bucket-container">
                <div class="bucket-fill" id="zero-percent-bucket" style="height: 0%;"></div>
            </div>
            <input type="text" id="zero-percent-value" class="bucket-value-numeric" readonly/>
            Withdrawals taxed at 10%
            <div class="bucket-container">
                <div class="bucket-fill" id="ten-percent-bucket" style="height: 0%;"></div>
            </div>
            <input type="text" id="ten-percent-value" class="bucket-value-numeric" readonly/>
            Withdrawals taxed at 12%
            <div class="bucket-container">
                <div class="bucket-fill"  id="twelve-percent-bucket" style="height: 0%;"></div>
            </div>
            <input type="text" id="twelve-percent-value" class="bucket-value-numeric" readonly/>
        </div>
        <div class="results">
            Total tax paid on all withdrawals
            <input type="text" id="total-tax" class="total-tax" readonly/>
            <div style="margin-bottom: 20px;" id="full-withdrawal-or-not"></div>
            <div style="margin-bottom: 20px;" id="min-tax-or-not"></div>
        </div>
    </div>

    <script>
        $(function() {
            const fullWithdrawalAmount = 100000;
            const minTax = 1240;
            
            const sizeOf0Bucket = 29200 * 3.0;
            const sizeOf10Bucket = 23200 * 3.0;
            const sizeOf12Bucket = 71100 * 3.0;

            const initialSliderValues = [50000, 30000, 20000];
            const initialBucketValues = [29200 + 29200 + 20000, 21600, 0];
            const initialTax = 2160;    
            
            const fullWithdrawalText = "You are withdrawing the entire intended amount. ✔️";
            const partialWithdrawalText = "You are not withdrawing the entire intended amount.  Move the sliders up until the add up to 100,000.";
            const optimalTax = "<strong>You are paying the lowest possible amount of income tax. ✔️</strong>";
            const suboptimalTax = "You are paying <em>more</em> income tax than you have to. Keep playing with the sliders!";

            function updateSliderHandles() {
                $(".slider-vertical").each(function() {
                    var value = $(this).slider("value");
                    $(this).find(".slider-filled").height((value / 100000) * $(this).height());
                });
            }

            function updateBuckets() {
                var amountIn0Bucket = 0;
                var amountIn10Bucket = 0;
                var amountIn12Bucket = 0;
                var taxFrom0Bucket = 0;
                var taxFrom10Bucket = 0;
                var taxFrom12Bucket = 0;
                var overallTax = 0;

                $(".slider-vertical").each(function() {
                    var value = $(this).slider("value");
                    amountIn0Bucket += Math.min(value, 29200);
                    amountIn10Bucket += Math.max(0, Math.min(value - 29200, 23200));
                    amountIn12Bucket += Math.max(0, Math.min(value - 52400, 71100));
                });

                taxFrom10Bucket = 0.10 * amountIn10Bucket;
                taxFrom12Bucket = 0.12 * amountIn12Bucket;
                overallTax = taxFrom0Bucket + taxFrom10Bucket + taxFrom12Bucket;
                
                $('#zero-percent-bucket').height(100 * amountIn0Bucket / sizeOf0Bucket + '%');
                $('#ten-percent-bucket').height(100 * amountIn10Bucket / sizeOf10Bucket + '%');
                $('#twelve-percent-bucket').height(100 * amountIn12Bucket / sizeOf12Bucket + '%');

                $('#zero-percent-value').val(amountIn0Bucket);
                $('#ten-percent-value').val(amountIn10Bucket);
                $('#twelve-percent-value').val(amountIn12Bucket);

                $('#total-tax').val(overallTax);
            }

            function updateTextMessages() {
                var totalWithdrawal = $('#slider-vertical-0').slider("value") + $('#slider-vertical-1').slider("value") + $('#slider-vertical-2').slider("value");
                if (totalWithdrawal == fullWithdrawalAmount) {
                    $('#full-withdrawal-or-not').html(fullWithdrawalText);

                    var totalTax = $('#total-tax').val();
                    if (totalTax == minTax) {
                        $('#min-tax-or-not').html(optimalTax);
                    } else if (totalTax > minTax) {
                        $('#min-tax-or-not').html(suboptimalTax);
                    } else {
                        $('#min-tax-or-not').html("Error, sorry.");
                    }
                } else if (totalWithdrawal < fullWithdrawalAmount) {
                    $('#full-withdrawal-or-not').html(partialWithdrawalText);
                    $('#min-tax-or-not').html("");
                } else {
                    $('#full-withdrawal-or-not').text("Error, sorry.");
                    $('#min-tax-or-not').html("");
                }

                

                
            }

            // Don't let the sliders past the total withdrawal amount
            function restrictSliders(index, proposedValue) {
                var allowedValue = proposedValue;
                var total = 0;

                // Calculate the total of the first three sliders
                $(".slider-vertical").each(function(i) {
                    if (i !== index) { // Exclude the current slider
                        total += $(this).slider("value");
                    }
                });

                var maxAllowedValue = 100000 - total; // Maximum value allowed for the current slider

                // If the proposed value is greater than the max allowed value, adjust it
                if (proposedValue > maxAllowedValue) {
                    allowedValue = maxAllowedValue;
                }

                return allowedValue; // Return the adjusted value for the slider
            }

            $(".slider-vertical").each(function(i) {
                var sliderId = 'slider-vertical-' + i;
                var sliderValueId = 'slider-value-' + i;                

                $('#' + sliderId).slider({
                    orientation: "vertical",
                    range: "min",
                    min: 0,
                    max: 100000,
                    value: initialSliderValues[i],
                    step: 1000,
                    slide: function(event, ui) {
                        var requestedValue = ui.value;
                        var adjustedValue = restrictSliders(i, requestedValue);

                        // If the adjusted value is different from the proposed value, prevent the
                        // slide.
                        if (adjustedValue !== requestedValue) {
                            event.preventDefault();
                        }

                        // I think the standard slider logic will update this value, but I'd like to do it
                        // before calling the update functions as a simple way to avoid them working on 
                        // numbers from before this event.  And it doesn't seem to hurt anything.
                        $(this).slider("value", adjustedValue);
                        $('#' + sliderValueId).val(adjustedValue);
                        updateSliderHandles();
                        updateBuckets();
                        updateTextMessages();
                    },
                    create: function(event, ui) {
                        var initialValue = $(this).slider("value");
                        var initialHeight = (initialValue / 100000) * $(this).height();
                        $(this).children('.slider-filled').height(initialHeight);
                        $('#' + sliderValueId).val(initialValue);
                    }
                });

                // Add change event listener to the first three text boxes
                $('#' + sliderValueId).on('change', function() {
                    var value = parseInt($(this).val()); // Get the integer value from the text box
                    if (isNaN(value) || value < 0) {
                        value = 0
                        $(this).val(0);
                    } 

                    var adjustedValue = restrictSliders(i, value);

                    $(this).val(adjustedValue);

                    $('#' + sliderId).slider("value", adjustedValue);
                    updateSliderHandles();
                    updateBuckets();
                    updateTextMessages();
                });

                // updateBuckets doesn't like to be called while initializing the slider,
                // so set hardcoded values initially.
                $('#zero-percent-bucket').height(100 * initialBucketValues[0] / sizeOf0Bucket + '%');
                $('#ten-percent-bucket').height(100 * initialBucketValues[1] / sizeOf10Bucket + '%');
                $('#twelve-percent-bucket').height(100 * initialBucketValues[2] / sizeOf12Bucket + '%');
                $('#zero-percent-value').val(initialBucketValues[0]);
                $('#ten-percent-value').val(initialBucketValues[1]);
                $('#twelve-percent-value').val(initialBucketValues[2]);
                $('#total-tax').val(initialTax);
                $('#full-withdrawal-or-not').html(fullWithdrawalText);
                $('#min-tax-or-not').html(suboptimalTax);
            });
        });
    </script>
</body>
</html>

